const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

console.log('üîÑ Configuration pour SQLite...\n');

// 1. Modifier schema.prisma
const schemaPath = path.join(__dirname, '..', 'prisma', 'schema.prisma');
let schemaContent = fs.readFileSync(schemaPath, 'utf8');

// Remplacer MySQL par SQLite
schemaContent = schemaContent.replace(
  /datasource db \{[^}]+\}/s,
  `datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}`
);

// D√©commenter SQLite si pr√©sent
schemaContent = schemaContent.replace(
  /\/\/ datasource db \{[\s\S]*?provider = "sqlite"[\s\S]*?\}/,
  `datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}`
);

// Commenter MySQL si pr√©sent
schemaContent = schemaContent.replace(
  /datasource db \{[\s\S]*?provider = "mysql"[\s\S]*?\}/,
  `// datasource db {
//   provider = "mysql"
//   url      = env("DATABASE_URL")
// }`
);

fs.writeFileSync(schemaPath, schemaContent);
console.log('‚úÖ schema.prisma modifi√© pour SQLite');

// 2. Cr√©er/modifier .env
const envPath = path.join(__dirname, '..', '.env');
let envContent = '';

if (fs.existsSync(envPath)) {
  envContent = fs.readFileSync(envPath, 'utf8');
  // Remplacer DATABASE_URL si pr√©sent
  if (envContent.includes('DATABASE_URL=')) {
    envContent = envContent.replace(
      /DATABASE_URL=.*/,
      'DATABASE_URL="file:./prisma/dev.db"'
    );
  } else {
    envContent += '\nDATABASE_URL="file:./prisma/dev.db"';
  }
} else {
  envContent = `DATABASE_URL="file:./prisma/dev.db"
PORT=3001
NODE_ENV=development`;
}

fs.writeFileSync(envPath, envContent);
console.log('‚úÖ Fichier .env configur√©');

// 3. Supprimer les migrations MySQL existantes
const migrationsPath = path.join(__dirname, '..', 'prisma', 'migrations');
if (fs.existsSync(migrationsPath)) {
  console.log('\n‚ö†Ô∏è  Suppression des migrations MySQL existantes...');
  fs.rmSync(migrationsPath, { recursive: true, force: true });
  console.log('‚úÖ Migrations supprim√©es');
}

// 4. Mettre √† jour migration_lock.toml
const lockPath = path.join(__dirname, '..', 'prisma', 'migrations', 'migration_lock.toml');
const lockDir = path.dirname(lockPath);
if (!fs.existsSync(lockDir)) {
  fs.mkdirSync(lockDir, { recursive: true });
}
fs.writeFileSync(lockPath, `# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "sqlite"
`);
console.log('‚úÖ migration_lock.toml configur√© pour SQLite');

console.log('\nüìã √âtapes suivantes :');
console.log('1. npm run prisma:generate');
console.log('2. npx prisma migrate dev --name init');
console.log('3. npm run dev');
console.log('\n‚ú® Configuration SQLite termin√©e !');
